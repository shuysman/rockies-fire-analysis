---
title: 'Rockies Fire Analysis'
author: "Stephen Huysman"
fontsize: 12pt 
bibliography: fire.bib
csl: global-ecology-and-biogeography.csl
---
# Preprocessing
1. Get MTBS database
  + Extract fire polys by location of interest (Ecoregion)
  + Create centroids for each poly (Pole of inaccessability in QGIS)
2. Get LANDFIRE EVT (Expected Vegetation Type data)
  + Use statistics tool in QGIS to get mean, median, and mode EVT by pixel count.  Only mode is used going further.
3. Create master csv file with points of interest.  Needs columns 'Event_ID', 'Incid_Type', 'Ig_Date', 'Lon', 'Lat, and 'LF20_EVT_5' (Landfire 2020 EVT type).  Further analysis can look at finer resolution LANDFIRE vegetation types offered.  
4. Get Historical WB data for each centroid from Mike
5. Get Historical gridmet climate data for Each centroid
  + gridmet-historical.R - download gridmet data for each point
	+ pr, tmmx, tmmn, rmax, rmin, vpd
	+ creates one dir 'gridmet-$var' for each variable
  + merge-csv.R
    + join Mike's data and historical gridmet data into one csv for each Event_ID
	+ use these csvs for input to this script

# Settings
```{r settings}
plot_theme <- theme_bw() +
    theme(text = element_text(size = 22))
```


# Master dataframe
Read in file containing meta data for fires of interest.
```{r metadata}
library(tidyverse)
library(multidplyr)
library(zoo)
library(slider)
library(pROC)

## Directory containing metadata file
data_dir <- "/home/steve/OneDrive/nothern-rockies-dryness"
## Directory with csv files from merge-csv.R
out_dir <- "/media/steve/storage/waterbalance/fire/out/ap23/"

setwd(data_dir)

master <- read_csv("SR_fire_points_extracted.csv") %>%
    filter(Incid_Type == "Wildfire") %>%
    rename("maj_veg_cl" = LF20_EVT_5) %>%
    ##  maj_class is the majority
    ##    of pixels classification from Landfire 30m pixels in burned
    ##    areas, this data was extracted in QGIS.
    mutate(maj_veg_cl = case_match(maj_veg_cl,
                                   c("Herb", "Shrub", "Sparse") ~ "non-forest",
                                   "Tree" ~ "forest",
                                   c("Agriculture", "Water") ~ "other"),
           filename = paste0(Event_ID, ".csv"),
           doy = yday(Ig_Date))

```


# Determine Fire Season
```{r fire-seasons}
forest<-subset(master, maj_veg_cl=="forest");forest
forest_q<-quantile(forest$doy,c(0,1));forest_q#90% of data fall within this range 0.05-0.95# 0.27 to 0.75 or 0,1 to determine min max

nonforest<-subset(master, maj_veg_cl=="non-forest");nonforest
nonforest_q<-quantile(nonforest$doy,c(0,1));nonforest_q#90% of data fall within this range 0.05-0.95# 0.27 to 0.75 or 0,1 to determine min

#start and end dates of fire season by vegetation type derived from day of year in min_max table
doy_min_max<-as.data.frame(rbind(forest_q, nonforest_q));doy_min_max
forest_start<-doy_min_max[1,1]
nonforest_start<-doy_min_max[2,1]
forest_end<-doy_min_max[1,2]
nonforest_end<-doy_min_max[2,2]
```


# Compute Percentiles
```{r analysis}
cores <- parallel::detectCores() - 4
cluster <- new_cluster(cores)

window <- 14 ## Window of days to calculate rolling values
vars <- c("RD", "VPD", "T", "SOIL", "AWSSM", "RAIN", "AET", "D", "GDD")

cluster_copy(cluster, "master")
cluster_copy(cluster, "window")
cluster_copy(cluster, "vars")
cluster_copy(cluster, "forest_start")
cluster_copy(cluster, "nonforest_start")
cluster_copy(cluster, "forest_end")
cluster_copy(cluster, "nonforest_end")
cluster_library(cluster, 'tidyverse')
cluster_library(cluster, 'slider')
cluster_library(cluster, 'zoo')


files <- paste0(out_dir, master$filename)
cluster_assign_partition(cluster, files = files)
cluster_send(cluster, wbdata <- vroom::vroom(files, id = "PATH"))
wbdata <- party_df(cluster, "wbdata")
master <- party_df(cluster, "master")

wbdata <- wbdata %>%
    mutate(Event_ID = str_extract(PATH, '(?<=/)[^/]*(?=\\.[^./]+$)')) %>% ## Extract file name without extension, use as Event_ID
    group_by(Event_ID) %>%
    mutate(RD = 100 - RH,
           WHC = max(SOIL), ## Guestimate soil WHC from max soil moisture observed
           AWSSM = WHC - SOIL) %>%
    left_join(select(master,
                     Event_ID, Ig_Date, maj_veg_cl),
              by = "Event_ID") %>%
    mutate(fire = if_else(Date == Ig_Date, 1, 0)) 

start <- proc.time() # Start clock
wbdata_smoothed <- select(wbdata, c(Event_ID, Ig_Date, maj_veg_cl, fire, Date, vars)) %>%
    ## mutate_at(vars[1:5],
    ##           ~ slide_dbl(.x, mean, .before = window, .after = 0, .complete = TRUE)) %>%
    ## mutate_at(vars[6:9],
    ##           ~ slide_dbl(.x, sum, .before = window, .after = 0, .complete = TRUE)) %>%
    mutate_at(vars[1:5],
              ~ rollapply(.x, window, mean, by = 1, partial = FALSE, fill = NA, align = "right")) %>%
    mutate_at(vars[6:9],
              ~ rollapply(.x, window, sum, by = 1, partial = FALSE, fill = NA, align = "right")) 
time_elapsed_parallel <- proc.time() - start # End clock

wbdata_percentiles_forest <- select(wbdata_smoothed, c(Event_ID, Ig_Date, maj_veg_cl, fire, Date, vars)) %>%
    filter(maj_veg_cl == "forest") %>%
    filter(Date <= Ig_Date,
           yday(Date) >= forest_start, ## Filter to fire season
           yday(Date) <= forest_end) %>%  ## To get this to match results from original dryness_script2, we only filter beginning of season
    slice(window + 1:n()) %>%
    mutate(across(vars,
                  percent_rank)) %>%
    collect()

wbdata_percentiles_nonforest <- select(wbdata_smoothed, c(Event_ID, Ig_Date, maj_veg_cl, fire, Date, vars)) %>%
    filter(maj_veg_cl == "non-forest") %>%
    filter(Date <= Ig_Date,
           yday(Date) >= nonforest_start,  ## Filter to fire season
           yday(Date) <= nonforest_end) %>%
    slice(window + 1:n()) %>%
    mutate(across(vars,
                  percent_rank)) %>%
    collect()

ignitions_forest <- wbdata_percentiles_forest %>% filter(fire == 1)
nonignitions_forest <- wbdata_percentiles_forest %>% filter(fire == 0)
ignitions_forest_long <- ignitions_forest %>% pivot_longer(cols = vars)
ignitions_nonforest <- wbdata_percentiles_nonforest %>% filter(fire == 1)
nonignitions_nonforest <- wbdata_percentiles_nonforest %>% filter(fire == 0)
ignitions_nonforest_long <- ignitions_nonforest %>% pivot_longer(cols = vars)
ignitions_long <- rbind(ignitions_forest_long, ignitions_nonforest_long)
```

# ROC Analysis
```{r forest_roc, include = TRUE, eval = T, message = F}
forest_rd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$RD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_vpd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$VPD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_temp_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$T, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_soil_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$SOIL, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_gdd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$GDD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_awssm_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$AWSSM, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_rain_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$RAIN, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_aet_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$AET, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_d_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$D, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)

par(pty = "s") ## pty sets the aspect ratio of the plot region. Two options:
##                "s" - creates a square plotting region
##                "m" - (the default) creates a maximal plotting region
par(bg="white")
plot.roc(col="pink",forest_rd_roc, lwd=4, print.auc=FALSE, main = "Forest")
plot.roc(add=TRUE,col="dark blue",forest_vpd_roc, main="vpd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="green",forest_temp_roc, main="temp", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="red",forest_soil_roc, main="soil", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="brown",forest_gdd_roc, main="gdd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="magenta",forest_awssm_roc, main="awssm", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="purple",forest_rain_roc, main="rain", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="dark green",forest_aet_roc, main="aet", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="orange",forest_d_roc, main="d", lwd=4, print.auc=FALSE)
                                        # Add a legend
legend(35, 75, legend=c(paste("RD ",round(auc(forest_rd_roc),1)),
                                        #paste("SVP ",round(auc(forest_svp_roc),1)),
                        paste("VPD ",round(auc(forest_vpd_roc),1)),
                        paste("TEMP ",round(auc(forest_temp_roc),1)),
                        paste("SOIL ",round(auc(forest_soil_roc),1)),
                        paste("GDD ",round(auc(forest_gdd_roc),1)),
                        paste("SWD",round(auc(forest_awssm_roc),1)),
                        paste("RAIN ",round(auc(forest_rain_roc),1)),
                        paste("AET ",round(auc(forest_aet_roc),1)),
                        paste("CWD ",round(auc(forest_d_roc),1))),
       bty="n", col=c("pink", "dark blue","green","red","brown","magenta","purple","dark green","orange"), #col=c("black","blue", "dark blue","green","red","brown","magenta","purple","dark green","orange")
       lty=1, lwd=4, text.font=2)#cex=0.9,
text(1,75,"AUC")
```

```{r nonforest_roc, eval = T, include = T, message = F}
nonforest_rd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$RD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_vpd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$VPD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_temp_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$T, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_soil_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$SOIL, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_gdd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$GDD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_awssm_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$AWSSM, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_rain_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$RAIN, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_aet_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$AET, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_d_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$D, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)

par(pty = "s") ## pty sets the aspect ratio of the plot region. Two options:
##                "s" - creates a square plotting region
##                "m" - (the default) creates a maximal plotting region
par(bg="white")
plot.roc(col="pink",nonforest_rd_roc, lwd=4, print.auc=FALSE, main = "Nonforest")
plot.roc(add=TRUE,col="dark blue",nonforest_vpd_roc, main="vpd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="green",nonforest_temp_roc, main="temp", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="red",nonforest_soil_roc, main="soil", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="brown",nonforest_gdd_roc, main="gdd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="magenta",nonforest_awssm_roc, main="awssm", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="purple",nonforest_rain_roc, main="rain", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="dark green",nonforest_aet_roc, main="aet", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="orange",nonforest_d_roc, main="d", lwd=4, print.auc=FALSE)
                                        # Add a legend
legend(35, 75, legend=c(paste("RD ",round(auc(nonforest_rd_roc),1)),
                                        #paste("SVP ",round(auc(nonforest_svp_roc),1)),
                        paste("VPD ",round(auc(nonforest_vpd_roc),1)),
                        paste("TEMP ",round(auc(nonforest_temp_roc),1)),
                        paste("SOIL ",round(auc(nonforest_soil_roc),1)),
                        paste("GDD ",round(auc(nonforest_gdd_roc),1)),
                        paste("SWD",round(auc(nonforest_awssm_roc),1)),
                        paste("RAIN ",round(auc(nonforest_rain_roc),1)),
                        paste("AET ",round(auc(nonforest_aet_roc),1)),
                        paste("CWD ",round(auc(nonforest_d_roc),1))),
       bty="n", col=c("pink", "dark blue","green","red","brown","magenta","purple","dark green","orange"), #col=c("black","blue", "dark blue","green","red","brown","magenta","purple","dark green","orange")
       lty=1, lwd=4, text.font=2)#cex=0.9,
text(1,75,"AUC")
```

demonstrate histogram of conditions associated with fire or no fire to see how much overlap there is.  This helps interpret the ROC
```{r}
plot(density(ignitions_forest$D), col="red")
lines(density(nonignitions_forest$D), col="blue")

plot(density(ignitions_forest$VPD), col="red")
lines(density(nonignitions_forest$VPD), col="blue")
```

# ECDF

```{r ecdf all-vars}
ggplot(ignitions_long, aes(value, color = name)) +
    stat_ecdf(pad = FALSE) +
    xlab("Percentile at ignition") +
    facet_grid(~ maj_veg_cl) +
    plot_theme
```

```{r ecdf cwd-vpd}
ggplot(filter(ignitions_long,
              name %in% c("VPD", "D")),
       aes(value, color = name)) +
    stat_ecdf(pad = FALSE) +
    geom_hline(yintercept = .1) +
    geom_hline(yintercept = .4) +
    xlab("Percentile at ignition") +
    ylab("Proportion of Fires") +
    facet_grid(~ maj_veg_cl) +
    plot_theme
```
