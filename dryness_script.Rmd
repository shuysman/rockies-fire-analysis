---
title: 'Rockies Fire Analysis'
author: "Stephen Huysman"
date: "`r Sys.Date()`"
fontsize: 10pt 
bibliography: fire.bib
csl: global-ecology-and-biogeography.csl
output:
  html_document:
    toc: true
    toc_float: true
---
# Settings
```{r settings, include = T}
library(tidyverse)
library(multidplyr)
library(zoo)
library(slider)
library(pROC)

plot_theme <- theme_bw() 

cores <- parallel::detectCores() - 4
cluster <- new_cluster(cores)

window <- 7 ## Window of days to calculate rolling values
vars <- c("RD", "VPD", "T", "SOIL", "AWSSM", "RAIN", "AET", "D", "GDD")

region_name <- "Southern Rockies"  ## Set region name, should be same as L3 Ecoregion name

settings <- tribble(
    ~region, ~params,
    "Southern Rockies", list(data_dir =  "/home/steve/OneDrive/nothern-rockies-dryness",
                           out_dir =  "/media/steve/storage/waterbalance/fire/out/ap23/",
                           master_csv =  "SR_fire_points_extracted.csv"
                           ),
    "Middle Rockies", list(data_dir =  "/home/steve/OneDrive/nothern-rockies-dryness",
                           out_dir =  "/media/steve/storage/waterbalance/fire/out/",
                           master_csv =  "MR_fire_points_extracted.csv"
                           ),
)


settings <- settings %>% filter(region == region_name) 

## Directory containing metadata file
data_dir <- settings$params[[1]]$data_dir

## Directory with csv files from merge-csv.R
out_dir <- settings$params[[1]]$out_dir

master_csv <- settings$params[[1]]$master_csv
```

# `r region_name`

# Preprocessing
1. Get MTBS database
  + Extract fire polys by location of interest (Ecoregion)
  + Create centroids for each poly (Pole of inaccessability in QGIS)
2. Get LANDFIRE EVT (Existing Vegetation Type data)
  + Use statistics tool in QGIS to get mean, median, and mode EVT by pixel count.  Only mode is used going further.
3. Create master csv file with points of interest.  Needs columns 'Event_ID', 'Incid_Type', 'Ig_Date', 'x' (=Longitude), 'y' (=Latitiude), and 'LF20_EVT_5' (Landfire 2020 EVT type).  Further analysis can look at finer resolution LANDFIRE vegetation types offered.  
4. Get Historical WB data for each centroid from Mike
5. Get Historical gridmet climate data for Each centroid
  + gridmet-historical.R - download gridmet data for each point
	+ pr, tmmx, tmmn, rmax, rmin, vpd
	+ creates one dir 'gridmet-$var' for each variable
  + merge-csv.R
    + join Mike's data and historical gridmet data into one csv for each Event_ID
	+ use these csvs for input to this script

# Master dataframe
Read in file containing meta data for fires of interest.
```{r metadata, include = T}
setwd(data_dir)

master <- read_csv(master_csv) %>%
    filter(Incid_Type == "Wildfire") %>%
##    filter(year(Ig_Date) <= 2014) %>%
    rename("maj_veg_cl" = LF20_EVT_5,
           "Acres" = BurnBndAc) %>%
    ##  maj_class is the majority
    ##    of pixels classification from Landfire 30m pixels in burned
    ##    areas, this data was extracted in QGIS.
    mutate(maj_veg_cl = case_match(maj_veg_cl,
                                   c("Herb", "Shrub", "Sparse") ~ "non-forest",
                                   "Tree" ~ "forest",
                                   c("Agriculture", "Water") ~ "other"),
           filename = paste0(Event_ID, ".csv"),
           doy = yday(Ig_Date))
```

# Map

```{r map, fig.width = 8, fig.height = 8}
library(sp)
library(sf)

coords <- data.frame(
    x = master$x,
    y = master$y
)
spdf <- SpatialPointsDataFrame(coords = coords, data = master)

ecoregions <- st_transform(read_sf("/home/steve/OneDrive/nothern-rockies-dryness/data/us_eco_l3/us_eco_l3.shp"), crs = 4326)
ecoregion <- ecoregions %>% filter(US_L3NAME == region_name)

ggplot(ecoregion) +
    geom_sf() +
    geom_point(data = master, aes(x, y, color = maj_veg_cl))

summary_tbl <- master %>% group_by(maj_veg_cl) %>% summarise(n = n())
knitr::kable(summary_tbl)
```


# Determine Fire Season
```{r fire-seasons, include = T}
forest<-subset(master, maj_veg_cl=="forest")
forest_q<-quantile(forest$doy,c(0,1))#90% of data fall within this range 0.05-0.95# 0.27 to 0.75 or 0,1 to determine min max

nonforest<-subset(master, maj_veg_cl=="non-forest")
nonforest_q<-quantile(nonforest$doy,c(0,1))#90% of data fall within this range 0.05-0.95# 0.27 to 0.75 or 0,1 to determine min

#start and end dates of fire season by vegetation type derived from day of year in min_max table
doy_min_max<-as.data.frame(rbind(forest_q, nonforest_q))
forest_start<-doy_min_max[1,1]
nonforest_start<-doy_min_max[2,1]
forest_end<-doy_min_max[1,2]
nonforest_end<-doy_min_max[2,2]

knitr::kable(doy_min_max)
```

# Compute Percentiles
```{r analysis, include = T}
cluster_copy(cluster, "master")
cluster_copy(cluster, "window")
cluster_copy(cluster, "vars")
cluster_copy(cluster, "forest_start")
cluster_copy(cluster, "nonforest_start")
cluster_copy(cluster, "forest_end")
cluster_copy(cluster, "nonforest_end")
cluster_library(cluster, 'tidyverse')
cluster_library(cluster, 'slider')
cluster_library(cluster, 'zoo')


files <- paste0(out_dir, master$filename)
cluster_assign_partition(cluster, files = files)
cluster_send(cluster, wbdata <- vroom::vroom(files, id = "PATH"))
wbdata <- party_df(cluster, "wbdata")
master <- party_df(cluster, "master")

wbdata <- wbdata %>%
    mutate(Event_ID = str_extract(PATH, '(?<=/)[^/]*(?=\\.[^./]+$)')) %>% ## Extract file name without extension, use as Event_ID
    group_by(Event_ID) %>%
    mutate(RD = 100 - RH,
           WHC = max(SOIL), ## Guestimate soil WHC from max soil moisture observed
           AWSSM = WHC - SOIL) %>%
    left_join(select(master,
                     Event_ID, Ig_Date, maj_veg_cl, Acres),
              by = "Event_ID") %>%
    mutate(fire = if_else(Date == Ig_Date, 1, 0)) 

start <- proc.time() # Start clock
wbdata_smoothed <- select(wbdata, c(Event_ID, Ig_Date, maj_veg_cl, Acres, fire, Date, vars)) %>%
    ## mutate_at(vars[1:5],
    ##           ~ slide_dbl(.x, mean, .before = window, .after = 0, .complete = TRUE)) %>%
    ## mutate_at(vars[6:9],
    ##           ~ slide_dbl(.x, sum, .before = window, .after = 0, .complete = TRUE)) %>%
    mutate_at(vars[1:5],
              ~ rollapply(.x, window, mean, by = 1, partial = FALSE, fill = NA, align = "right")) %>%
    mutate_at(vars[6:9],
              ~ rollapply(.x, window, sum, by = 1, partial = FALSE, fill = NA, align = "right")) 
time_elapsed_parallel <- proc.time() - start # End clock

wbdata_percentiles_forest <- select(wbdata_smoothed, c(Event_ID, Ig_Date, maj_veg_cl, Acres, fire, Date, vars)) %>%
    filter(maj_veg_cl == "forest") %>%
    filter(Date <= Ig_Date,
           yday(Date) >= forest_start, ## Filter to fire season
           yday(Date) <= forest_end) %>%  ## To get this to match results from original dryness_script2, we only filter beginning of season.  Original script also didn't use doy, instead it filtered by absolute date, so would only chop off first pre-fireseason from first year in record.
##    slice(window + 1):n()) %>%
    collect() %>%
    drop_na(vars) %>% ### Drop NAs from periods not included in rolling calcs
    mutate(across(vars,
                  percent_rank))

wbdata_percentiles_nonforest <- select(wbdata_smoothed, c(Event_ID, Ig_Date, maj_veg_cl, Acres, fire, Date, vars)) %>%
    filter(maj_veg_cl == "non-forest") %>%
    filter(Date <= Ig_Date,
           yday(Date) >= nonforest_start,  ## Filter to fire season
           yday(Date) <= nonforest_end) %>%
    ##        slice((window + 1):n()) %>%
    collect() %>%
    drop_na(vars) %>% ### Drop NAs from periods not included in rolling calcs
    mutate(across(vars,
                  percent_rank)) 

ignitions_forest <- wbdata_percentiles_forest %>% filter(fire == 1)
nonignitions_forest <- wbdata_percentiles_forest %>% filter(fire == 0)
ignitions_forest_long <- ignitions_forest %>% pivot_longer(cols = vars)
ignitions_nonforest <- wbdata_percentiles_nonforest %>% filter(fire == 1)
nonignitions_nonforest <- wbdata_percentiles_nonforest %>% filter(fire == 0)
ignitions_nonforest_long <- ignitions_nonforest %>% pivot_longer(cols = vars)
ignitions_long <- rbind(ignitions_forest_long, ignitions_nonforest_long)


```

# Corrplot

```{r}
library(GGally)

ggcorr(wbdata_percentiles_forest, method = c("everything", "pearson")) 
```

<!-- # Autocorrelation -->

<!-- ```{r} -->
<!-- wbdata %>% collect() -->

<!-- acf(wbdata %>% filter(Event_ID == "CO3942710800419870707") %>% select(P:AWSSM, -Event_ID)) -->
<!-- ``` -->

# ROC Analysis
We use the AUC (area under the curve) of the ROC (receiver operating characteristic) as a measure of goodness-of-fit to evaluate which predictors to use in the fire danger model.  


```{r forest_roc, fig.width = 6, fig.height = 6, include = TRUE, eval = T, message = F, echo = F}
## library(lme4)

## #divide dataset into training and test set
## set.seed(1)
## sample <- sample(c(TRUE, FALSE), nrow(wbdata_percentiles_forest), replace=TRUE, prob=c(0.7,0.3))
## train <- wbdata_percentiles_forest[sample, ]
## test <- wbdata_percentiles_forest[!sample, ]

## df.list <- train %>%
##     group_by(name) %>%
##     group_split(name)

## map_function <- function(x){
##   pROC::roc(
##     data = x,
##     response = fire,
##     predictor = value
##   )
## }

## roc.list <- map(df.list, map_function)

## ggroc(roc.list, alpha = 0.5) +
##   theme_bw()


## forest_RD_mm <- glmer(fire ~ RD + (1 | Event_ID), family = "binomial", data = train)
## forest_VPD_mm <- glmer(fire ~ VPD + (1 | Event_ID), family = "binomial", data = train)
## forest_T_mm <- glmer(fire ~ T + (1 | Event_ID), family = "binomial", data = train)
## forest_SOIL_mm <- glmer(fire ~ SOIL + (1 | Event_ID), family = "binomial", data = train)
## forest_GDD_mm <- glmer(fire ~ GDD + (1 | Event_ID), family = "binomial", data = train)
## forest_AWSSM_mm <- glmer(fire ~ AWSSM + (1 | Event_ID), family = "binomial", data = train)
## forest_RAIN_mm <- glmer(fire ~ RAIN + (1 | Event_ID), family = "binomial", data = train)
## forest_D_mm <- glmer(fire ~ D + (1 | Event_ID), family = "binomial", data = train)
## forest_AET_mm <- glmer(fire ~ AET + (1 | Event_ID), family = "binomial", data = train)


## predicted_forest_RD_mm <- predict(forest_RD_mm, test, type = "response")
## predicted_forest_VPD_mm <- predict(forest_VPD_mm, test, type = "response")
## predicted_forest_T_mm <- predict(forest_T_mm, test, type = "response")
## predicted_forest_SOIL_mm <- predict(forest_SOIL_mm, test, type = "response")
## predicted_forest_GDD_mm <- predict(forest_GDD_mm, test, type = "response")
## predicted_forest_AWSSM_mm <- predict(forest_AWSSM_mm, test, type = "response")
## predicted_forest_RAIN_mm <- predict(forest_RAIN_mm, test, type = "response")
## predicted_forest_D_mm <- predict(forest_D_mm, test, type = "response")
## predicted_forest_AET_mm <- predict(forest_AET_mm, test, type = "response")

## roc.list <- list( RD = roc(test$fire, predicted_forest_RD_mm),
##                  VPD = roc(test$fire, predicted_forest_VPD_mm),
##                  T = roc(test$fire, predicted_forest_T_mm),
##                  SOIL = roc(test$fire, predicted_forest_SOIL_mm),
##                  GDD = roc(test$fire, predicted_forest_GDD_mm),
##                  AWSSM = roc(test$fire, predicted_forest_AWSSM_mm),
##                  RAIN = roc(test$fire, predicted_forest_RAIN_mm),
##                  D = roc(test$fire, predicted_forest_D_mm),
##                  AET = roc(test$fire, predicted_forest_AET_mm) )

## ggroc(roc.list, lwd = 2)

## forest_RD <- glm(fire ~ RD, family = "binomial", data = train)

## anova(forest_RD_mm, forest_RD, test = "Chisq")


## forest_VPD <- glm(fire ~ VPD, family = "binomial", data = train)
## forest_T <- glm(fire ~ T, family = "binomial", data = train)
## forest_SOIL <- glm(fire ~ SOIL, family = "binomial", data = train)
## forest_GDD <- glm(fire ~ GDD, family = "binomial", data = train)
## forest_AWSSM <- glm(fire ~ AWSSM, family = "binomial", data = train)
## forest_RAIN <- glm(fire ~ RAIN, family = "binomial", data = train)
## forest_AET <- glm(fire ~ AET, family = "binomial", data = train)
## forest_D <- glm(fire ~ D, family = "binomial", data = train)

## predicted_forest_RD <- predict(forest_RD, test, type = "response")
## predicted_forest_VPD <- predict(forest_VPD, test, type = "response")
## predicted_forest_T <- predict(forest_T, test, type = "response")
## predicted_forest_SOIL <- predict(forest_SOIL, test, type = "response")
## predicted_forest_GDD <- predict(forest_GDD, test, type = "response")
## predicted_forest_AWSSM <- predict(forest_AWSSM, test, type = "response")
## predicted_forest_RAIN <- predict(forest_RAIN, test, type = "response")
## predicted_forest_AET <- predict(forest_AET, test, type = "response")
## predicted_forest_D <- predict(forest_D, test, type = "response")

## rocobj_forest_RD <- roc(test$fire, predicted_forest_RD)
## rocobj_forest_VPD <- roc(test$fire, predicted_forest_VPD)
## rocobj_forest_T <- roc(test$fire, predicted_forest_T)
## rocobj_forest_SOIL <- roc(test$fire, predicted_forest_SOIL)
## rocobj_forest_GDD <- roc(test$fire, predicted_forest_GDD)
## rocobj_forest_AWSSM <- roc(test$fire, predicted_forest_AWSSM)
## rocobj_forest_RAIN <- roc(test$fire, predicted_forest_RAIN)
## rocobj_forest_AET <- roc(test$fire, predicted_forest_AET)
## rocobj_forest_D <- roc(test$fire, predicted_forest_D)

## ggroc(rocobj_forest_RD, colour = 'steelblue', size = 2)

## +
##     ggroc(rocobj_forest_VPD, colour = 'darkred', size = 2) +
##     ggroc(rocobj_forest_T, colour = 'orange', size = 2) +
##     ggroc(rocobj_forest_SOIL, colour = 'green', size = 2) +
##     ggroc(rocobj_forest_GDD, colour = 'purple', size = 2) +
##     ggroc(rocobj_forest_AWSSM, colour = 'aquamarine2', size = 2) +
##     ggroc(rocobj_forest_RAIN, colour = 'darkorchid2', size = 2) +
##     ggroc(rocobj_forest_AET, colour = 'deeppink', size = 2) +
##     ggroc(rocobj_forest_D, colour = 'firebrick1', size = 2) 
    
forest_rd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$RD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_vpd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$VPD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_temp_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$T, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_soil_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$SOIL, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_gdd_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$GDD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_awssm_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$AWSSM, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_rain_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$RAIN, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_aet_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$AET, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
forest_d_roc<-roc(wbdata_percentiles_forest$fire,wbdata_percentiles_forest$D, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)

par(pty = "s") ## pty sets the aspect ratio of the plot region. Two options:
##                "s" - creates a square plotting region
##                "m" - (the default) creates a maximal plotting region
par(bg="white")
plot.roc(col="pink",forest_rd_roc, lwd=4, print.auc=FALSE, main = "Forest")
plot.roc(add=TRUE,col="dark blue",forest_vpd_roc, main="vpd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="green",forest_temp_roc, main="temp", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="red",forest_soil_roc, main="soil", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="brown",forest_gdd_roc, main="gdd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="magenta",forest_awssm_roc, main="awssm", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="purple",forest_rain_roc, main="rain", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="dark green",forest_aet_roc, main="aet", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="orange",forest_d_roc, main="d", lwd=4, print.auc=FALSE)
                                        # Add a legend
legend(35, 75, legend=c(paste("RD ",round(auc(forest_rd_roc),1)),
                                        #paste("SVP ",round(auc(forest_svp_roc),1)),
                        paste("VPD ",round(auc(forest_vpd_roc),1)),
                        paste("TEMP ",round(auc(forest_temp_roc),1)),
                        paste("SOIL ",round(auc(forest_soil_roc),1)),
                        paste("GDD ",round(auc(forest_gdd_roc),1)),
                        paste("SWD",round(auc(forest_awssm_roc),1)),
                        paste("RAIN ",round(auc(forest_rain_roc),1)),
                        paste("AET ",round(auc(forest_aet_roc),1)),
                        paste("CWD ",round(auc(forest_d_roc),1))),
       bty="n", col=c("pink", "dark blue","green","red","brown","magenta","purple","dark green","orange"), #col=c("black","blue", "dark blue","green","red","brown","magenta","purple","dark green","orange")
       lty=1, lwd=4, text.font=2)#cex=0.9,
text(1,75,"AUC")
```

```{r nonforest_roc, fig.width = 6, fig.height = 6, eval = T, message = F, echo = F}
nonforest_rd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$RD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_vpd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$VPD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_temp_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$T, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_soil_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$SOIL, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_gdd_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$GDD, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_awssm_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$AWSSM, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_rain_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$RAIN, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_aet_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$AET, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)
nonforest_d_roc<-roc(wbdata_percentiles_nonforest$fire,wbdata_percentiles_nonforest$D, plot=FALSE, legacy.axes=TRUE, percent=TRUE, col="#377eb8", lwd=4, print.auc=TRUE)

par(pty = "s") ## pty sets the aspect ratio of the plot region. Two options:
##                "s" - creates a square plotting region
##                "m" - (the default) creates a maximal plotting region
par(bg="white")
plot.roc(col="pink",nonforest_rd_roc, lwd=4, print.auc=FALSE, main = "Nonforest")
plot.roc(add=TRUE,col="dark blue",nonforest_vpd_roc, main="vpd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="green",nonforest_temp_roc, main="temp", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="red",nonforest_soil_roc, main="soil", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="brown",nonforest_gdd_roc, main="gdd", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="magenta",nonforest_awssm_roc, main="awssm", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="purple",nonforest_rain_roc, main="rain", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="dark green",nonforest_aet_roc, main="aet", lwd=4, print.auc=FALSE)
plot.roc(add=TRUE,col="orange",nonforest_d_roc, main="d", lwd=4, print.auc=FALSE)
                                        # Add a legend
legend(35, 75, legend=c(paste("RD ",round(auc(nonforest_rd_roc),1)),
                                        #paste("SVP ",round(auc(nonforest_svp_roc),1)),
                        paste("VPD ",round(auc(nonforest_vpd_roc),1)),
                        paste("TEMP ",round(auc(nonforest_temp_roc),1)),
                        paste("SOIL ",round(auc(nonforest_soil_roc),1)),
                        paste("GDD ",round(auc(nonforest_gdd_roc),1)),
                        paste("SWD",round(auc(nonforest_awssm_roc),1)),
                        paste("RAIN ",round(auc(nonforest_rain_roc),1)),
                        paste("AET ",round(auc(nonforest_aet_roc),1)),
                        paste("CWD ",round(auc(nonforest_d_roc),1))),
       bty="n", col=c("pink", "dark blue","green","red","brown","magenta","purple","dark green","orange"), #col=c("black","blue", "dark blue","green","red","brown","magenta","purple","dark green","orange")
       lty=1, lwd=4, text.font=2)#cex=0.9,
text(1,75,"AUC")
```

demonstrate histogram of conditions associated with fire or no fire to see how much overlap there is.  This helps interpret the ROC
```{r density-hist, echo = F, message = F}
plot(density(ignitions_forest$D), col="red")
lines(density(nonignitions_forest$D), col="blue")

plot(density(ignitions_forest$VPD), col="red")
lines(density(nonignitions_forest$VPD), col="blue")
```

Determine contribution of various parameters to burned area
```{r burned-area-contrib, echo = F, message = F}
library(hier.part)

y<-as.vector(ignitions_nonforest[,"Acres"])
xcann<-subset(ignitions_nonforest,select=c("T","SOIL","GDD","AWSSM","AET","D","RD","VPD"))
hier.part(y,xcann,barplot=TRUE)

y<-as.vector(ignitions_forest[,"Acres"])
xcann<-subset(ignitions_forest,select=c("T","SOIL","GDD","AWSSM","AET","D","RD","VPD"))
hier.part(y,xcann,barplot=TRUE)
```

Plots of wb percentile vs. area burned show weak relationships
```{r wb-vs-area, fig.width = 8, fig.height = 8, echo = F, message = F}
ggplot(ignitions_long, aes(x=value, y=Acres, colour=factor(maj_veg_cl))) +
    geom_point(size=3) +
    geom_smooth(method="lm", se=FALSE) +
    facet_wrap(~name, scales="fixed") +
    labs(title = "", x = "Percentile at Week of Ignition", y = "Area burned (Acres)", color = NULL)+
    scale_color_manual(values=c("red","black")) +
    plot_theme
```

```{r wb-vs-logarea, fig.width = 8, fig.height = 8, echo = F, message = F}
ggplot(ignitions_long, aes(x=value, y=log(Acres), colour=factor(maj_veg_cl))) +
    geom_point(size=3) +
    geom_smooth(method="lm", se=FALSE) +
    facet_wrap(~name, scales="fixed") +
    labs(title = "", x = "Percentile at Week of Ignition", y = "Area burned (log Acres)", color = NULL)+
    scale_color_manual(values=c("red","black")) +
    plot_theme
```

# ECDF

```{r ecdf-all-vars, fig.width = 8, fig.height = 4, echo = F}
ggplot(ignitions_long, aes(value, color = name)) +
    stat_ecdf(pad = FALSE) +
    xlab("Percentile at ignition") +
    facet_grid(~ maj_veg_cl) +
    plot_theme
```

```{r ecdf-cwd-vpd, fig.width = 8, fig.height = 4, echo = F} 
ggplot(filter(ignitions_long,
              name %in% c("VPD", "D")),
       aes(value, color = name)) +
    stat_ecdf(pad = FALSE) +
    geom_hline(yintercept = .1) +
    geom_hline(yintercept = .4) +
    xlab("Percentile at ignition") +
    ylab("Proportion of Fires") +
    facet_grid(~ maj_veg_cl) +
    plot_theme
```

# Fire Danger Model

The fire danger model uses ECDF curves of water balance percentiles on day of ignition.  We can use the logistic regression models evaluated in the ROC analysis to estimate probability of ignition for given water balance percentiles for a given day, but due to the very large number of non-ignition days in the dataset, the probability of ignition for any given day will be extremely low.  Instead, we will look only at days that had an ignition, and compare the water balance percentiles for those days.  This allows us to, for example, take a percentile of water deficit on a given day and compare that to the proportion of historic fires that burned at or below this value.  

Low fire danger is taken as the water balance percentile at or below which 10% of historical fires ignited.

High fire danger is taken as the water balance percentile at or below which 40% of historical fires ignited.


```{r ecdf-regression-setup}
regression_formulas <- tribble(
    ~cover, ~var, ~order, ~formula, ~r2
)

precision <- 7

regression1_formula <- function(a, b) {
    ## Regression formula in string format
    a <- round(a, precision)
    b <- round(b, precision)
    return (paste0("y = ", a, "e^(", b, "x)"))
}

regression2_formula <- function(b0, b1, b2) {
    ## Regression formula in string format
    b0 <- round(b0, precision)
    b1 <- round(b1, precision)
    b2 <- round(b2, precision)
    return (paste0("y = e^(", b0, " + ", b1, "x + ", b2, "x^2)"))
}

regression3_formula <- function(b0, b1, b2, b3) {
    ## Regression formula in string format
    b0 <- round(b0, precision)
    b1 <- round(b1, precision)
    b2 <- round(b2, precision)
    b3 <- round(b3, precision)
    return (paste0("y = e^(", b0, " + ", b1, "x + ", b2, "x^2 + ", b3, "x^3)"))
}

```

## First Order

```{r ecdf-regression1}
ecdf_regression1 <- function(ecdf_fn) {
    estimated <- data.frame(
        dec = seq(from = 0.01, to = 0.99, by = 0.01)
    )

    estimated$quants <- quantile(ecdf_fn, estimated$dec)
    estimated$proportions <- ecdf_fn(estimated$quants)

    lm <- lm(log(proportions) ~ quants, data = estimated)
    estimated$predicted <- exp(predict(lm, data = estimated$quants))
    
    ##plot(lm)

    a <- exp(lm$coefficients[[1]])
    b <- lm$coefficients[[2]]

    return (list(lm = lm,
                 estimated = estimated,
                 a = a,
                 b = b))
}

```

```{r ecdf-regression1-plot}
ecdf_regression1_plot <- function(ecdf_fn, estimated, a, b) {
    high_thresh <- .4
    low_thresh <- .1
    
    regression_fn <- function(x) {
        a <- a
        b <- b
        return (a*exp(b*x))
    }

    plot(ecdf_fn)
    points(y = estimated$proportions, x = estimated$quants, col = "blue")
    points(y = estimated$predicted, x = estimated$quants, col = "red")
    curve(regression_fn, add = TRUE, col = "red")
    x_low <- round(log(low_thresh/a)/b,2)
    segments(0, low_thresh, x1 = x_low, y1 = low_thresh) ## Low Fire Danger horiz
    text(x = .3, y = low_thresh + 0.02, label = "Low Fire Danger")
    segments(x_low, 0, x1 = x_low, y1 = low_thresh) ## Low Fire Danger vert
    text(x = x_low, y = -.02, label = x_low)
    x_high <- round(log(high_thresh/a)/b,2)
    segments(0, high_thresh, x1 = x_high, y1 = high_thresh) ## High Fire Danger horiz
    text(x = .3, y = high_thresh + 0.02, label = "High Fire Danger")
    segments(x_high, 0, x1 = x_high, y1 = high_thresh) ## High Fire Danger vert
    text(x = x_high, y = -.02, label = x_high)
}
```

### CWD Forest


```{r ecdf-regression-d-forest}
ecdf_fn <- ecdf(ignitions_forest$D)
summary(ecdf_fn)

regression_list <- ecdf_regression1(ecdf_fn)
estimated <- regression_list$estimated
lm <- regression_list$lm
r2 <- summary(lm)$adj.r.squared
a <- regression_list$a
b <- regression_list$b

summary(lm)

ecdf_regression1_plot(ecdf_fn, estimated, a, b)

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "1", cover = "forest", formula = regression1_formula(a, b), r2 = r2)
```


Estimated function predicting proportion of historic fires burning in forests at or below given percentile of climatic water deficit on day of ignition:

$\begin{align*}f(x) = `r a` e^{`r b` x}\end{align*}$

### VPD Forest

```{r ecdf-regression-vpd-forest}
ecdf_fn <- ecdf(ignitions_forest$VPD)
summary(ecdf_fn)

regression_list <- ecdf_regression1(ecdf_fn)
estimated <- regression_list$estimated
lm <- regression_list$lm
r2 <- summary(lm)$adj.r.squared
a <- regression_list$a
b <- regression_list$b

summary(lm)

ecdf_regression1_plot(ecdf_fn, estimated, a, b)

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "1", cover = "forest", formula = regression1_formula(a, b), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in forests at or below given percentile of vapor pressure deficit on day of ignition:

$\begin{align*}f(x) = `r a` e^{`r b` x}\end{align*}$

### CWD Non-Forest

```{r ecdf-regression-d-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$D)
summary(ecdf_fn)

regression_list <- ecdf_regression1(ecdf_fn)
estimated <- regression_list$estimated
lm <- regression_list$lm
r2 <- summary(lm)$adj.r.squared
a <- regression_list$a
b <- regression_list$b

summary(lm)

ecdf_regression1_plot(ecdf_fn, estimated, a, b)

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "1", cover = "nonforest", formula = regression1_formula(a, b), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of climatic water deficit on day of ignition:

$\begin{align*}f(x) = `r a` e^{`r b` x}\end{align*}$

### VPD Non-Forest

```{r ecdf-regression-vpd-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$VPD)
summary(ecdf_fn)

regression_list <- ecdf_regression1(ecdf_fn)
estimated <- regression_list$estimated
lm <- regression_list$lm
r2 <- summary(lm)$adj.r.squared
a <- regression_list$a
b <- regression_list$b

summary(lm)

ecdf_regression1_plot(ecdf_fn, estimated, a, b)

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "1", cover = "nonforest", formula = regression1_formula(a, b), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of vapor pressure deficit on day of ignition:

$\begin{align*}f(x) = `r a` e^{`r b` x}\end{align*}$

## Second Order
Fits to ECDF curves may be improved by including a quadtratic term in regression

### CWD Forest

```{r ecdf-regression2-d-forest}
ecdf_fn <- ecdf(ignitions_forest$D)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 2, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "2", cover = "forest", formula = regression2_formula(b0, b1, b2), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in forests at or below given percentile of CWD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2}\end{align*}$

### VPD Forest

```{r ecdf-regression2-vpd-forest}
ecdf_fn <- ecdf(ignitions_forest$VPD)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 2, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "2", cover = "forest", formula = regression2_formula(b0, b1, b2), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in forests at or below given percentile of VPD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2}\end{align*}$

### CWD Non-forest

```{r ecdf-regression2-d-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$D)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 2, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "2", cover = "nonforest", formula = regression2_formula(b0, b1, b2), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of CWD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2}\end{align*}$

### VPD Non-forest

```{r ecdf-regression2-vpd-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$VPD)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 2, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "2", cover = "nonforest", formula = regression2_formula(b0, b1, b2), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of VPD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2}\end{align*}$

## Third Order

### CWD Forest

```{r ecdf-regression3-d-forest}
ecdf_fn <- ecdf(ignitions_forest$D)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 3, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]
b3 <- lm$coefficients[[4]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2) + b3*(x^3)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "3", cover = "forest", formula = regression3_formula(b0, b1, b2, b3), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in forests at or below given percentile of CWD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2 + `r b3`x^3}\end{align*}$

### VPD Forest

```{r ecdf-regression3-vpd-forest}
ecdf_fn <- ecdf(ignitions_forest$VPD)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 3, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]
b3 <- lm$coefficients[[4]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2) + b3*(x^3)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "3", cover = "forest", formula = regression3_formula(b0, b1, b2, b3), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in forests at or below given percentile of VPD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2 + `r b3`x^3}\end{align*}$

### CWD Non-forest

```{r ecdf-regression3-d-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$D)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 3, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]
b3 <- lm$coefficients[[4]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2) + b3*(x^3)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "D", order = "3", cover = "nonforest", formula = regression3_formula(b0, b1, b2, b3), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of CWD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2 + `r b3`x^3}\end{align*}$

### VPD Non-forest

```{r ecdf-regression3-vpd-nonforest}
ecdf_fn <- ecdf(ignitions_nonforest$VPD)
summary(ecdf_fn)

estimated <- data.frame(
    dec = seq(from = 0.01, to = 0.99, by = 0.01)
)

estimated$quants <- quantile(ecdf_fn, estimated$dec)
estimated$proportions <- ecdf_fn(estimated$quants)

lm <- lm(log(proportions) ~ poly(quants, 3, raw = TRUE), data = estimated)
r2 <- summary(lm)$adj.r.squared
estimated$predicted <- exp(predict(lm, data = estimated$quants))

##plot(lm)

summary(lm)

b0 <- lm$coefficients[[1]]
b1 <- lm$coefficients[[2]]
b2 <- lm$coefficients[[3]]
b3 <- lm$coefficients[[4]]

plot(ecdf_fn)
points(y = estimated$proportions, x = estimated$quants, col = "blue")
points(y = estimated$predicted, x = estimated$quants, col = "red")
curve(exp(b0 + b1*x + b2*(x^2) + b3*(x^3)), add = TRUE, col = "red")
##curve(exp(predict(lm, newdata = data.frame(quants = x))), add = TRUE, col = "red")

regression_formulas <- regression_formulas %>%
    add_row(var = "VPD", order = "3", cover = "nonforest", formula = regression3_formula(b0, b1, b2, b3), r2 = r2)
```

Estimated function predicting proportion of historic fires burning in nonforests at or below given percentile of VPD on day of ignition:

$\begin{align*}f(x) = e^{`r b0` + `r b1`x + `r b2`x^2 + `r b3`x^3}\end{align*}$


## Estimated Regression Formulas
`r knitr::kable(regression_formulas)`
